### Neuen Benutzer registrieren
POST http://localhost:8000/api/v1/auth/register
Content-Type: application/json

{
  "username": "immunization.schedule",
  "firstName": "Immunization",
  "lastName": "Schedule",
  "birthDate": "1990-05-15",
  "email": "immunization.schedule@example.com",
  "password": "securePassword123"
}

> {%
    client.test("Registrierung erfolgreich (201 Created)", function() {
        client.assert(response.status === 201, "Status ist nicht 201, sondern: " + response.status);
    });

    client.test("User ID vorhanden", function() {
        client.assert(response.body.id !== undefined, "Keine User ID in Response");
    });

    // User ID für weitere Tests speichern
    client.global.set("currentUserId", response.body.id);
    client.log("User ID gespeichert: " + response.body.id);
%}

### Benutzer einloggen
POST http://localhost:8000/api/v1/auth/login
Content-Type: application/json

{
  "username": "immunization.schedule",
  "password": "securePassword123"
}

> {%
    client.test("Status ist 200", function() {
        client.assert(response.status === 200, "Erwartet: 200, Erhalten: " + response.status);
    });

    client.test("Token vorhanden", function() {
        client.assert(response.body.token !== undefined, "Kein Token in Response");
    });

    // Token global speichern
    client.global.set("authToken", response.body.token);
    client.log("Token gespeichert: " + response.body.token);
%}

### Voraussetzung: VaccineTypes abrufen
GET http://localhost:8000/api/v1/vaccine-types
Authorization: Bearer {{authToken}}

> {%
    client.test("VaccineTypes vorhanden", function() {
        client.assert(response.body.vaccineTypeDtoList.length > 0, "Keine VaccineTypes gefunden");
    });

    if (response.body.vaccineTypeDtoList.length > 0) {
        client.global.set("vaccineTypeId1", response.body.vaccineTypeDtoList[0].id);
        client.log("VaccineType 1: " + response.body.vaccineTypeDtoList[0].name);
    }
    if (response.body.vaccineTypeDtoList.length > 1) {
        client.global.set("vaccineTypeId2", response.body.vaccineTypeDtoList[1].id);
        client.log("VaccineType 2: " + response.body.vaccineTypeDtoList[1].name);
    }
    if (response.body.vaccineTypeDtoList.length > 2) {
        client.global.set("vaccineTypeId3", response.body.vaccineTypeDtoList[2].id);
        client.log("VaccineType 3: " + response.body.vaccineTypeDtoList[2].name);
    }
%}

### Voraussetzung: AgeCategories abrufen
GET http://localhost:8000/api/v1/age-categories
Authorization: Bearer {{authToken}}

> {%
    client.test("AgeCategories vorhanden", function() {
        client.assert(response.body.length > 0, "Keine AgeCategories gefunden");
    });

    if (response.body.length > 0) {
        client.global.set("ageCategoryId1", response.body[0].id);
        client.log("AgeCategory 1: " + response.body[0].name);
    }
%}

### Voraussetzung: Impfeinträge erstellen (abgeschlossene Impfung)
POST http://localhost:8000/api/v1/immunization-records
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "userId": "{{currentUserId}}",
  "vaccineTypeId": "{{vaccineTypeId1}}",
  "ageCategoryId": "{{ageCategoryId1}}",
  "administeredOn": "2023-03-15",
  "doseOrderClaimed": 1
}

> {%
    client.test("Impfeintrag 1 erstellt", function() {
        client.assert(response.status === 201, "Status ist nicht 201");
    });

    client.global.set("recordId1", response.body.id);
    client.log("Impfeintrag 1 ID: " + response.body.id);
%}

### Voraussetzung: Zweite Impfung erstellen
POST http://localhost:8000/api/v1/immunization-records
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "userId": "{{currentUserId}}",
  "vaccineTypeId": "{{vaccineTypeId2}}",
  "ageCategoryId": "{{ageCategoryId1}}",
  "administeredOn": "2023-04-20",
  "doseOrderClaimed": 1
}

> {%
    client.test("Impfeintrag 2 erstellt", function() {
        client.assert(response.status === 201, "Status ist nicht 201");
    });

    client.global.set("recordId2", response.body.id);
    client.log("Impfeintrag 2 ID: " + response.body.id);
%}

### Eigene ausstehende Impfungen abrufen (pending)
GET http://localhost:8000/api/v1/immunization-schedule/pending
Authorization: Bearer {{authToken}}

> {%
    client.test("Status ist 200", function() {
        client.assert(response.status === 200, "Erwartet: 200, Erhalten: " + response.status);
    });

    client.test("Response hat alle erforderlichen Felder", function() {
        client.assert(response.body.userId !== undefined, "userId fehlt");
        client.assert(response.body.username !== undefined, "username fehlt");
        client.assert(response.body.birthDate !== undefined, "birthDate fehlt");
        client.assert(response.body.currentAgeDays !== undefined, "currentAgeDays fehlt");
        client.assert(response.body.pendingImmunizations !== undefined, "pendingImmunizations fehlt");
        client.assert(response.body.totalPending !== undefined, "totalPending fehlt");
        client.assert(response.body.overdueCount !== undefined, "overdueCount fehlt");
        client.assert(response.body.dueSoonCount !== undefined, "dueSoonCount fehlt");
        client.assert(response.body.upcomingDueCount !== undefined, "upcomingDueCount fehlt");
    });

    client.test("Username korrekt", function() {
        client.assert(response.body.username === "immunization.schedule", "Username nicht korrekt");
    });

    client.test("User ID korrekt", function() {
        client.assert(response.body.userId === client.global.get("currentUserId"), "User ID stimmt nicht überein");
    });

    client.test("CurrentAgeDays ist positiv", function() {
        client.assert(response.body.currentAgeDays > 0, "CurrentAgeDays sollte positiv sein");
    });

    client.test("PendingImmunizations ist ein Array", function() {
        client.assert(Array.isArray(response.body.pendingImmunizations), "pendingImmunizations ist kein Array");
    });

    client.test("TotalPending ist >= 0", function() {
        client.assert(response.body.totalPending >= 0, "totalPending sollte >= 0 sein");
    });

    client.test("Priority Counters ergeben TotalPending", function() {
        var sum = response.body.overdueCount + response.body.dueSoonCount + response.body.upcomingDueCount;
        client.assert(sum === response.body.totalPending, "Summe der Prioritäten stimmt nicht mit totalPending überein");
    });

    client.log("Total Pending: " + response.body.totalPending);
    client.log("High Priority: " + response.body.overdueCount);
    client.log("Medium Priority: " + response.body.dueSoonCount);
    client.log("Low Priority: " + response.body.dueSoonCount);
    client.log("Current Age (Days): " + response.body.currentAgeDays);
    client.log("Pending Immunizations: " + response.body.pendingImmunizations.length);
%}

### Eigene ausstehende Impfungen Zusammenfassung abrufen (pending/summary)
GET http://localhost:8000/api/v1/immunization-schedule/pending/summary
Authorization: Bearer {{authToken}}

> {%
    client.test("Status ist 200", function() {
        client.assert(response.status === 200, "Erwartet: 200, Erhalten: " + response.status);
    });

    client.test("Summary hat alle erforderlichen Felder", function() {
        client.assert(response.body.totalPending !== undefined, "totalPending fehlt");
        client.assert(response.body.overdueCount !== undefined, "highPriority fehlt");
        client.assert(response.body.dueSoonCount !== undefined, "mediumPriority fehlt");
        client.assert(response.body.upcomingDueCount !== undefined, "lowPriority fehlt");
        client.assert(response.body.currentAgeDays !== undefined, "currentAgeDays fehlt");
    });

    client.test("TotalPending ist >= 0", function() {
        client.assert(response.body.totalPending >= 0, "totalPending sollte >= 0 sein");
    });

    client.test("Priority Counters sind numerisch", function() {
        client.assert(typeof response.body.overdueCount === "number", "highPriority ist keine Zahl");
        client.assert(typeof response.body.dueSoonCount === "number", "mediumPriority ist keine Zahl");
        client.assert(typeof response.body.upcomingDueCount === "number", "lowPriority ist keine Zahl");
    });

    client.test("CurrentAgeDays ist positiv", function() {
        client.assert(response.body.currentAgeDays > 0, "currentAgeDays sollte positiv sein");
    });

    client.log("Summary - Total Pending: " + response.body.totalPending);
    client.log("Summary - High Priority: " + response.body.highPriority);
    client.log("Summary - Medium Priority: " + response.body.mediumPriority);
    client.log("Summary - Low Priority: " + response.body.lowPriority);
    client.log("Summary - Current Age (Days): " + response.body.currentAgeDays);
%}

### Pending Immunizations erneut abrufen (Konsistenzcheck)
GET http://localhost:8000/api/v1/immunization-schedule/pending
Authorization: Bearer {{authToken}}

> {%
    client.test("Status ist 200", function() {
        client.assert(response.status === 200, "Erwartet: 200, Erhalten: " + response.status);
    });

    client.test("Response ist konsistent", function() {
        client.assert(response.body.userId !== undefined, "userId fehlt in zweiter Abfrage");
        client.assert(response.body.username === "immunization.schedule", "Username inkonsistent");
    });

    // Speichere Werte für Vergleich
    client.global.set("pendingCount", response.body.totalPending);
%}

### Pending nach neuer Impfung prüfen (sollte sich ggf. ändern)
GET http://localhost:8000/api/v1/immunization-schedule/pending
Authorization: Bearer {{authToken}}

> {%
    client.test("Status ist 200", function() {
        client.assert(response.status === 200, "Erwartet: 200, Erhalten: " + response.status);
    });

    client.test("Pending-Liste wurde aktualisiert", function() {
        // Nach neuer Impfung könnte sich die Anzahl geändert haben
        client.assert(response.body.totalPending >= 0, "totalPending sollte >= 0 sein");
    });

    client.log("Total Pending nach neuer Impfung: " + response.body.totalPending);
    client.log("Vorheriger Wert: " + client.global.get("pendingCount"));
%}

### Summary nach neuer Impfung prüfen
GET http://localhost:8000/api/v1/immunization-schedule/pending/summary
Authorization: Bearer {{authToken}}

> {%
    client.test("Status ist 200", function() {
        client.assert(response.status === 200, "Erwartet: 200, Erhalten: " + response.status);
    });

    client.test("Summary konsistent nach Update", function() {
        var sum = response.body.overdueCount + response.body.dueSoonCount + response.body.upcomingDueCount;
        client.assert(sum === response.body.totalPending, "Summe der Prioritäten stimmt nicht mit totalPending überein");
    });

    client.log("Summary nach Update - Total: " + response.body.totalPending);
%}

### Pending Immunizations - Detailprüfung
GET http://localhost:8000/api/v1/immunization-schedule/pending
Authorization: Bearer {{authToken}}

> {%
    client.test("Status ist 200", function() {
        client.assert(response.status === 200, "Erwartet: 200, Erhalten: " + response.status);
    });
%}

### Kaan Pending Immunizations - eigene Daten prüfen auf Prriority
GET http://localhost:8000/api/v1/immunization-schedule/pending/overdue
Authorization: Bearer {{authToken}}

> {%
    client.test("Status ist 200", function() {
        client.assert(response.status === 200, "Erwartet: 200, Erhalten: " + response.status);
    });
%}

### Kaan Pending Immunizations - eigene Daten prüfen auf Prriority
GET http://localhost:8000/api/v1/immunization-schedule/pending/due-soon
Authorization: Bearer {{authToken}}

> {%
    client.test("Status ist 200", function() {
        client.assert(response.status === 200, "Erwartet: 200, Erhalten: " + response.status);
    });
%}

### Kaan Pending Immunizations - eigene Daten prüfen auf Prriority
GET http://localhost:8000/api/v1/immunization-schedule/pending/upcoming
Authorization: Bearer {{authToken}}

> {%
    client.test("Status ist 200", function() {
        client.assert(response.status === 200, "Erwartet: 200, Erhalten: " + response.status);
    });
%}


### Pending ohne Authorization (Fehlerfall)
GET http://localhost:8000/api/v1/immunization-schedule/pending

> {%
    client.test("Status ist 401 oder 403", function() {
        client.assert(response.status === 401 || response.status === 403, "Erwartet: 401 oder 403, Erhalten: " + response.status);
    });
%}

### Summary ohne Authorization (Fehlerfall)
GET http://localhost:8000/api/v1/immunization-schedule/pending/summary

> {%
    client.test("Status ist 401 oder 403", function() {
        client.assert(response.status === 401 || response.status === 403, "Erwartet: 401 oder 403, Erhalten: " + response.status);
    });
%}

### Pending mit ungültigem Token (Fehlerfall)
GET http://localhost:8000/api/v1/immunization-schedule/pending
Authorization: Bearer invalid-token-12345

> {%
    client.test("Status ist 401 oder 403", function() {
        client.assert(response.status === 401 || response.status === 403, "Erwartet: 401 oder 403, Erhalten: " + response.status);
    });
%}

### Final Check - Pending Immunizations
GET http://localhost:8000/api/v1/immunization-schedule/pending
Authorization: Bearer {{authToken}}

> {%
    client.test("Status ist 200", function() {
        client.assert(response.status === 200, "Erwartet: 200, Erhalten: " + response.status);
    });

    client.test("Alle Daten konsistent", function() {
        client.assert(response.body.userId === client.global.get("currentUserId"), "User ID inkonsistent");
        client.assert(response.body.username === "immunization.schedule", "Username inkonsistent");
    });

    client.log("=== FINAL CHECK ===");
    client.log("Total Pending: " + response.body.totalPending);
    client.log("High Priority: " + response.body.highPriority);
    client.log("Medium Priority: " + response.body.mediumPriority);
    client.log("Low Priority: " + response.body.lowPriority);
    client.log("Pending Immunizations Count: " + response.body.pendingImmunizations.length);
    client.log("Current Age (Days): " + response.body.currentAgeDays);
%}

### Final Check - Summary
GET http://localhost:8000/api/v1/immunization-schedule/pending/summary
Authorization: Bearer {{authToken}}

> {%
    client.test("Status ist 200", function() {
        client.assert(response.status === 200, "Erwartet: 200, Erhalten: " + response.status);
    });

    client.test("Summary vollständig", function() {
        client.assert(response.body.totalPending >= 0, "totalPending ungültig");
    });

    client.log("=== FINAL SUMMARY ===");
    client.log("Total Pending: " + response.body.totalPending);
    client.log("Current Age (Days): " + response.body.currentAgeDays);
%}

### Cleanup: Impfeinträge löschen
DELETE http://localhost:8000/api/v1/immunization-records/{{recordId1}}
Authorization: Bearer {{authToken}}

> {%
    client.test("Impfeintrag 1 gelöscht", function() {
        client.assert(response.status === 204, "Status ist nicht 204");
    });
%}

### Cleanup: Zweiten Impfeintrag löschen
DELETE http://localhost:8000/api/v1/immunization-records/{{recordId2}}
Authorization: Bearer {{authToken}}

> {%
    client.test("Impfeintrag 2 gelöscht", function() {
        client.assert(response.status === 204, "Status ist nicht 204");
    });
%}

### Benutzer löschen
DELETE http://localhost:8000/api/v1/auth
Authorization: Bearer {{authToken}}
Content-Type: application/json

> {%
    client.test("Status ist 204", function() {
        client.assert(response.status === 204, "Erwartet: 204, Erhalten: " + response.status);
    });

%}
